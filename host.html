<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.js"></script>
    <title>Host interface</title>
  </head>
  <body>

    <div class="container-fluid mt-1" id="game">
      <div class="row">
        <div class="col text-center">
          Bank: <span data-bind="text: bankAmount"></span>
        </div>
        <div class="col text-center">
          Bank this round: <span data-bind="text: bankAmountThisRound"></span>
        </div>
        <div class="col text-center">
          Current amount: <span data-bind="text: currentAmount"></span>
        </div>
      </div>
      <button type="button" class="btn btn-info btn-lg btn-block" data-bind="click: actionStart, hidden: timerIsRunning">
        <span data-bind="hidden: timerIsRunning">START ROUND</span>
      </button>

      <div class="row mt-2" data-bind="hidden: timerIsRunning">
        <div class="col">
          <button type="button" class="btn btn-secondary btn-lg btn-block" data-bind="click: actionDuDuDuDu">♪ DU DU DU DU ♪</button>
        </div>
        <div class="col">
          <button type="button" class="btn btn-secondary btn-lg btn-block" data-bind="click: actionGoodbye">♪ GOODBYE ♪</button>
        </div>
      </div>

      <button type="button" class="btn btn-info btn-lg btn-block mt-2" disabled data-bind="visible: timerIsRunning">
        Current player: <strong data-bind="text: currentPlayer"></strong><br />
        <span data-bind="if: hasQuestionAvailable"><span data-bind="text: currentQuestion"></span><br /></span>
        <span data-bind="visible: timerIsRunning">Time left: <strong data-bind="text: timeLeft"></strong></span>

      </button>

      <button type="button" class="btn btn-primary btn-lg btn-block mt-2" data-bind="click: actionBank, visible: timerIsRunning">BANK</button>
      <button type="button" class="btn btn-success btn-lg btn-block" data-bind="click: actionCorrect, visible: timerIsRunning">CORRECT</button>
      <button type="button" class="btn btn-danger btn-lg btn-block" data-bind="click: actionNope, visible: timerIsRunning">NOPE</button>

      <div class="row mt-3">
        <div class="col">
          Enter players name, separated with a comma.<br />
          <small>Remove the weakest link once the round has ended!</small>
        </div>
      </div>
      <div class="input-group ">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon1">@</span>
        </div>
        <input type="text" class="form-control" placeholder="Usernames (comma-separated)" aria-label="Usernames" aria-describedby="basic-addon1" data-bind="value: playersRaw, disable: timerIsRunning">
      </div>

      <div class="row mt-3">
        <div class="col">
          How long (in seconds) should a round last? (<span data-bind="text: roundDuration"></span>)
        </div>
      </div>
      <div class="input-group">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon1">#</span>
        </div>
        <input type="number" class="form-control" placeholder="Round duration" aria-label="Round duration" aria-describedby="basic-addon1" data-bind="value: roundDurationRaw, disable: timerIsRunning" min="10" max="150" step="10">
      </div>
      <div class="row mt-3">
        <div class="col">
          <small>[Optional]</small> Enter question list here, separated with a newline :
          <textarea class="form-control" placeholder="What is Question 1 ? (answer)" rows="3" data-bind="value: questionsRaw"></textarea>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col text-center">
          Players URL: <a href="${PLAYER_URL}">${PLAYER_URL}</a> (connected: <span data-bind="text: connectedPlayersCount"></span>)
          <span data-bind="if: timerIsRunning">
            <br />
            <a href="#" data-bind="click: actionStopRound">Stop round early</a>
          </span>
        </div>
      </div>
      <div class="row mt-3" data-bind="if: questionsFailedThisRound().length > 0 && !timerIsRunning()">
        <div class="col">
          <h3>Incorrect answers this round</h3>
          <ul data-bind="foreach: questionsFailedThisRound">
            <li data-bind="text: $data"></li>
          </ul>
        </div>
      </div>
    </div>


    <script src="/socket.io/socket.io.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const gameId = urlParams.get('game_id');
      var socket = io({query: { game_id: gameId, host: true }});

      function AppViewModel() {
        this.steps = [0, 50, 100, 200, 400, 1000, 2000, 3000, 4000, 5000]
        this.bankAmount = ko.observable(0);
        this.bankAmountThisRound = ko.observable(0);
        this.currentStep = ko.observable(0);
        this.playersRaw = ko.observable('Player1,Player2,Player3');
        this.roundDurationRaw = ko.observable(150);
        this.timeLeftRaw = ko.observable(150);
        this.timerIsRunning = ko.observable(false);
        this.music = ko.observable(null);
        this.connectedPlayersCount = ko.observable(0); // how many players are connected
        this.currentQuestionIndex = ko.observable(0);
        this.questionsRaw = ko.observable('');
        this.questionsFailedThisRound = ko.observableArray([]);

        this.players = ko.computed(function() {
          return this.playersRaw().split(',');
        }, this);

        this.currentPlayer = ko.computed(function() {
          const p = this.players();
          return p[this.currentQuestionIndex() % p.length]
        }, this);

        this.roundDuration = ko.computed(function() {
          setTimeout(() => this.sendJSON(), 1);
          return `${Math.floor(this.roundDurationRaw() / 60)}m${Math.floor(this.roundDurationRaw() % 60)}s`
        }, this);

        this.timeLeft = ko.computed(function() {
          return `${Math.floor(this.timeLeftRaw() / 60)}m${Math.floor(this.timeLeftRaw() % 60)}s`
        }, this);

        this.currentAmount = ko.computed(function() {
          return this.steps[this.currentStep()];
        }, this);

        this.questions = ko.computed(function() {
          return this.questionsRaw().split('\n').filter(Boolean);
        }, this)

        this.currentQuestion = ko.computed(function() {
          return this.questions()[this.currentQuestionIndex()];
        }, this);

        this.hasQuestionAvailable = ko.computed(function() {
          return this.questions().length > this.currentQuestionIndex();
        }, this);

        this.actionBank = () => {
          this.bankAmount(this.bankAmount() + this.currentAmount());
          this.bankAmountThisRound(this.bankAmountThisRound() + this.currentAmount());
          this.currentStep(0);
          this.sendJSON();
        }

        this.actionCorrect = () => {
          if(this.currentStep() >= this.steps.length - 1) {
            return;
          }
          this.currentStep(this.currentStep() + 1);
          this.currentQuestionIndex(this.currentQuestionIndex() + 1);
          this.sendJSON();
        }

        this.actionNope = () => {
          this.currentStep(0);
          this.questionsFailedThisRound.push(this.currentQuestion());
          this.currentQuestionIndex(this.currentQuestionIndex() + 1);
          this.sendJSON();
        }

        let intervalId;
        this.actionStart = () => {
          this.currentStep(0);
          this.bankAmountThisRound(0);
          this.questionsFailedThisRound.removeAll();
          this.timerIsRunning(true);
          this.timeLeftRaw(this.roundDurationRaw());
          this.playMusic('game.mp3')
          this.sendJSON();

          intervalId = setInterval(() => {
            this.timeLeftRaw(this.timeLeftRaw() - 1);

            if(this.timeLeftRaw() <= 0) {
              this.actionStopRound();
            }
            this.sendJSON();
          }, 1000)
        }

        this.actionDuDuDuDu = () => {
          this.playMusic("du-du-du-du.mp3");
        }

        this.actionGoodbye = () => {
          this.playMusic("goodbye.mp3");
        }

        this.actionStopRound = () => {
          clearInterval(intervalId);
          this.timerIsRunning(false);
          this.currentStep(0);
          // Consume the current question to make sure it's not displayed again next round
          this.currentQuestionIndex(this.currentQuestionIndex() + 1);
          this.playMusic("end.mp3");
        }

        this.playMusic = (musicName) => {
          // Send music, and remove it immediately
          this.music(musicName);
          this.sendJSON();
          this.music(null);
          setTimeout(() => {
            this.sendJSON();
          }, 10);
        }

        var lastSentJson = {};
        this.sendJSON = () => {
          // Only send if something changed
          const whitelist = ['steps', 'bankAmountThisRound', 'currentAmount', 'timeLeft', 'currentPlayer', 'currentStep', 'music', 'timerIsRunning']
          const data = {};
          whitelist.forEach(k => {
            data[k] = typeof(this[k]) === "function" ? this[k]() : this[k];
          });
          const jsonData = JSON.stringify(data);
          if(lastSentJson !== jsonData) {
            socket.emit('update_state', jsonData)
            lastSentJson = jsonData;
          }
        }
      }

      const state = new AppViewModel();
      // Activates knockout.js
      ko.applyBindings(state, document.getElementById('game'));

      state.sendJSON();

      socket.on('user_count', (connectedPlayersCount) => {
        state.connectedPlayersCount(connectedPlayersCount);
      })
    </script>
  </body>
</html>
